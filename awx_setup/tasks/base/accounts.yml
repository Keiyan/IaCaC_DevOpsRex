---

- name: Creating password for localais
  set_fact:
    localais_password: "{{ lookup('password', '/dev/null length=12 chars=ascii_letters,digits,punctuation') }}"

- name: create localais account
  include_tasks: functions/create_awx_object.yml
  loop:
    - variable: 'localais_account'
      api: 'users'
      search:
        username: 'localais'
      body:
        first_name: ""
        last_name: ""
        email: "root@localhost"
        username: "localais"
        password: "{{ localais_password }}"
        password_confirm: "{{ localais_password }}"
        user_type: 
          type: "system_administrator"
          label: "System Administrator"
        is_superuser: true
        is_system_auditor: false
      
# This is a modification over our initial script, which stores the password in an Azure Keyvault
- name: display localais password
  debug:
    var: localais_password

- name: get admin account
  uri:
    headers:
      Authorization: Bearer {{ awx.token }}
    url: "{{ awx.uri }}/api/v2/users/?search=admin"
    validate_certs: "{{ validate_certs }}"
    method: GET
  register: admin_account

- block:
  - name: Create token to remove admin
    uri:
      url: "{{ awx.uri }}/api/v2/tokens/"
      user: "localais"
      password: "{{ localais_password }}"
      force_basic_auth: true
      validate_certs: "{{ validate_certs }}"
      method: POST
      status_code: 201
      follow_redirects: all
      body_format: json
      body:
        description: "Admin account deletion"
        application: null
        scope: "write"
    register: localais_token

  - name: remove admin account
    uri:
      headers:
        Authorization: Bearer {{ localais_token.json.token }}
      url: "{{ awx.uri }}/api/v2/users/{{ admin_account.json.results[0].id }}"
      method: DELETE
      validate_certs: "{{ validate_certs }}"
      follow_redirects: all
      status_code: 204
  when: 
    - admin_account.json.count == 1
    - localais_account_exists == 'absent'
    - keep_admin_account is not defined or keep_admin_account == false # We use a control variable to allow keeping the default account, for example on dev computer
